---
title: "Timecourse Shrinkage with functional FDR"
author: "Sean Hackett"
date: "9/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In my last post, I discussed regression and likelihood-based methods for detecting temporal dynamics in timecourse data. These experiments typically involve perturbing a steady-state system at "time zero" and then measuring how the system changes at subsequent time points.

When working with such data I find that its useful to separate modeling into two phases. The first goal is to detect timecourses containing signal using statistical methods (the subject of **post**). Once this has been accomplished, we can proceed to characterize these signals using a wider array of methods (signal processing, mechanistic models, phenomonological models, stats/ML).


```{r}
library(dplyr)
library(ggplot2)
library(tidyr)

# ggplot default theme
theme_set(theme_bw())
```

```{r create_timecourse_dataset}
timepts <- c(0, 5, 10, 20, 30, 40, 60, 90) # time points measured
measurement_sd <- 0.5 # standard deviation of Gaussian noise added to each observation

# simulate timecourses from Chechik & Koller impulse model
devtools::source_gist("https://gist.github.com/shackett/e4a1a9b930623580282cd64d33a802c4")

simulated_timecourses <- simulated_timecourses %>%
  filter(signal == "contains signal")
```

```{r}
example_tcs <- simulated_timecourses %>%
  distinct(tc_id) %>%
  sample_n(5) %>%
  mutate(label = as.character(1:n()))

simulated_timecourses %>%
  inner_join(example_tcs, by = "tc_id") %>%
  ggplot(aes(x = time, color = label)) +
  geom_path(aes(y = sim_fit)) +
  geom_point(aes(y = abundance)) +
  scale_y_continuous("Abundance") +
  scale_color_brewer("Example Timecourse", palette = "Set2") +
  ggtitle("Simulated timecourses containing signal", "line: true values, points: observed values") +
  theme(legend.position = "bottom")
```




# estimate the FDR for significant timecourses


```{r timecourse_filtering}

# Using non-centered z-statics generated from log-fold change and gene + timecourse noise estimate the local false discovery rate (lfdr) of individual observations
observation_signals <- simulated_timecourses %>%
  # hold out measurement that are exactly zero since they are zero by construction
  dplyr::filter(fold_change != 0) %>%
  dplyr::mutate(z_score = fold_change / sqrt(2*measurement_sd^2)) %>%
  dplyr::mutate(p_norm = 1 - abs(0.5 - pnorm(z_score))*2)
  
ggplot(observation_signals, aes(x = p_norm, y = ..density..)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ time, scale = "free_y") +
  ggtitle("Within significant timecourses, early timepoints are generally noise; later timepoints, generally are signal")
```


```{r observation_level_fdr}
library(fFDR)

fq <- fqvalue(observation_signals$p_norm, observation_signals$time)

pi_zero_by_t <- estimate_fpi0(p = observation_signals$p_norm,
                              z0 = observation_signals$time)$table %>%
  dplyr::distinct(z0, fpi0) %>%
  dplyr::group_by(z0) %>%
  dplyr::slice(1) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(z0)
qplot(y = pi_zero_by_t$fpi0, x = pi_zero_by_t$z0) +
  scale_x_discrete("Time") +
  scale_y_continuous(expression(pi[0] ~ "= E[F / (T + F)]")) +
  theme_bw()
timepoint_lists <- observation_signals %>%
  plyr::dlply(.variables = "time", dplyr::tbl_df)
# calculate the lfdr for each observation using a timepoint specific lfdr
shrunken_timecourse_estimates <- lapply(timepoint_lists, function(a_time_set) {
  a_time_set$lfdr <- qvalue::lfdr(a_time_set$p_norm, pi0 = pi_zero_by_t$fpi0[pi_zero_by_t$z0 == a_time_set$time[1]])
  a_time_set
}) %>%
  dplyr::bind_rows() %>%
  dplyr::mutate(shrunken_log2_ratio = log2_ratio * (1-lfdr)) %>%
  dplyr::select(TF:gene, tc_level_hard = log2_ratio, tc_level_soft = shrunken_log2_ratio)
```

```{r}
tc_distances <- shrunken_timecourse_estimates %>%
  dplyr::group_by(TF, strain, date, restriction, mechanism, gene) %>%
  dplyr::arrange(desc(time)) %>%
  dplyr::slice(1) %>%
  dplyr::summarize(final_zero_pt = ifelse(tc_level_soft == 0, TRUE, FALSE)) %>%
  dplyr::left_join(overall_timecourse_signal, by = c("TF", "strain", "date", "restriction", "mechanism", "gene"))
ggplot(tc_distances, aes(x = q_chisq, y = ..density.., fill =  final_zero_pt)) +
  geom_density(alpha = 0.5)
```


```{r}
ggplot(shrunken_timecourse_estimates %>%
         dplyr::sample_n(2000), aes(x = tc_level_hard, y = tc_level_soft)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point(size = 0.2, color = "RED") +
  facet_wrap(~ time) +
  coord_cartesian(xlim = c(-4,4), ylim = c(-4,4)) +
  theme_minimal()
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
